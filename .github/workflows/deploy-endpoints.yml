name: Deploy Endpoints to Zabbix

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'endpoints.csv'
      - 'generate_configs.py'
      - 'deploy.sh'
      - 'zabbix_sync.sh'

  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permite fazer push de commits
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # N√£o precisa gerar configs aqui, o deploy.sh faz isso dinamicamente

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          
          # Instalar yq (YAML processor)
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Deploy to Zabbix
        env:
          ZBX_API_URL: ${{ secrets.ZABBIX_API_URL }}
          ZBX_TOKEN: ${{ secrets.ZABBIX_TOKEN }}
        run: |
          echo "üöÄ Iniciando deploy no Zabbix..."
          
          # Verifica se as vari√°veis est√£o definidas
          if [ -z "$ZBX_API_URL" ] || [ -z "$ZBX_TOKEN" ]; then
            echo "‚ùå ERRO: Secrets ZABBIX_API_URL ou ZABBIX_TOKEN n√£o configurados!"
            echo "Configure em: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          echo "‚úÖ API URL configurada: $ZBX_API_URL"
          
          # Converte line endings para Unix
          dos2unix zabbix_sync.sh deploy.sh 2>/dev/null || {
            sed -i 's/\r$//' zabbix_sync.sh
            sed -i 's/\r$//' deploy.sh
          }
          
          # Atualiza as vari√°veis no script
          sed -i "s|ZBX_API_URL=.*|ZBX_API_URL=\"$ZBX_API_URL\"|" zabbix_sync.sh
          sed -i "s|ZBX_TOKEN=.*|ZBX_TOKEN=\"$ZBX_TOKEN\"|" zabbix_sync.sh
          
          chmod +x zabbix_sync.sh
          chmod +x deploy.sh
          chmod +x generate_configs.py
          
          # Executa o deploy (gera configs dinamicamente)
          ./deploy.sh
